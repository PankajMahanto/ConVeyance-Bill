<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Conveyance Bill Tracker (Final Version)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure number/time input controls are visible */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button,
        input[type=time]::-webkit-calendar-picker-indicator {
            opacity: 1;
        }
        /* Styles for edit mode */
        tr.editing .view-mode {
            display: none;
        }
        tr.editing .edit-mode {
            display: block;
        }
        /* Hide edit inputs by default */
        .edit-mode {
            display: none;
        }
        /* Style for edit-mode inputs for better mobile usability */
        .edit-input {
            @apply w-full p-1 text-sm border border-gray-300 rounded-md shadow-sm;
        }
        /* Custom modal for alerts */
        .custom-modal {
            transition: opacity 0.25s ease;
        }
        .custom-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        
        <!-- Header -->
        <div class="p-4 md:p-6 bg-blue-600">
            <h1 class="text-xl md:text-2xl font-bold text-white">Conveyance Bill Tracker</h1>
            <p class="text-xs text-blue-200 mt-1">Data automatically saves in your browser.</p>
        </div>

        <!-- Company Name Input -->
        <div class="p-4 md:p-6 border-b border-gray-200 bg-blue-50">
             <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
             <input type="text" id="company-name" name="company-name" placeholder="Enter your company name for reports" class="mt-1 block w-full md:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>

        <!-- Input Form -->
        <form id="bill-form" class="p-4 md:p-6 border-b border-gray-200 grid grid-cols-2 md:grid-cols-6 gap-3 md:gap-4 items-end">
            <!-- Day Field -->
            <div class="col-span-1">
                <label for="day" class="block text-sm font-medium text-gray-700">Day</label>
                <input type="date" id="day" name="day" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
            </div>
            <!-- Time Field (Optional) -->
            <div class="col-span-1">
                <label for="time" class="block text-sm font-medium text-gray-700">Time (Opt.)</label>
                <input type="time" id="time" name="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <!-- Item / From Field (Optional) -->
            <div class="col-span-1">
                <label for="from" class="block text-sm font-medium text-gray-700">Item / From</label>
                <input type="text" id="from" name="from" placeholder="e.g., Home, Lunch" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <!-- Vendor / To Field (Optional) -->
            <div class="col-span-1">
                <label for="to" class="block text-sm font-medium text-gray-700">Vendor / To</label>
                <input type="text" id="to" name="to" placeholder="e.g., Office, Canteen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <!-- Category / Transport Field -->
            <div class="col-span-1">
                <label for="transport" class="block text-sm font-medium text-gray-700">Category</label>
                <input type="text" id="transport" name="transport" placeholder="e.g., Bus, Food" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
            </div>
            <!-- Amount Field -->
            <div class="col-span-1">
                <label for="amount" class="block text-sm font-medium text-gray-700">Amount (Tk.)</label>
                <input type="number" id="amount" name="amount" min="0" step="0.01" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
            </div>
            <button type="submit" class="col-span-2 md:col-span-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow transition duration-150 ease-in-out">
                Add Bill Entry
            </button>
        </form>

        <!-- Download Buttons (Responsive Stack) -->
        <div class="p-4 bg-gray-50 border-b border-gray-200 flex flex-col sm:flex-row gap-2 justify-end">
            <button id="finalize-day" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow text-sm transition duration-150">
                Finalize Day's Report (PDF + CSV)
            </button>
            <button id="download-csv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow text-sm transition duration-150">
                Download All (CSV)
            </button>
            <button id="download-pdf" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow text-sm transition duration-150">
                Download All (PDF)
            </button>
        </div>

        <!-- Bill Table (Wrapped for Horizontal Scroll on Mobile) -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[110px]">Day</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[90px]">Time</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Item / From</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Vendor / To</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Category</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Amount</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">Action</th>
                    </tr>
                </thead>
                <tbody id="bill-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be dynamically inserted here by JavaScript -->
                </tbody>
                <tfoot class="bg-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-700 uppercase">Total</td>
                        <td id="total-amount" class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900">0.00</td>
                        <td class="px-6 py-4"></td> <!-- Empty cell for action column -->
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Messages (Replaces alert()) -->
    <div id="app-modal" class="custom-modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm mx-auto rounded-lg shadow-2xl p-6 transform scale-100 transition duration-300">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-red-600">Error</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="text-gray-700">
                <p>An unexpected error occurred.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Form elements
            const billForm = document.getElementById('bill-form');
            const dayInput = document.getElementById('day');
            const timeInput = document.getElementById('time');
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            const transportInput = document.getElementById('transport');
            const amountInput = document.getElementById('amount');
            const companyNameInput = document.getElementById('company-name');

            // Table elements
            const tableBody = document.getElementById('bill-table-body');
            const totalAmountCell = document.getElementById('total-amount');

            // Action buttons
            const downloadCsvBtn = document.getElementById('download-csv');
            const downloadPdfBtn = document.getElementById('download-pdf');
            const finalizeDayBtn = document.getElementById('finalize-day');
            
            // Modal elements
            const modal = document.getElementById('app-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // App state and storage keys
            const BILLS_STORAGE_KEY = 'conveyanceBills';
            const COMPANY_STORAGE_KEY = 'companyName';
            let bills = [];
            let companyName = '';

            // --- Modal Functions (Replaces alert()) ---
            const showModal = (title, content, isError = true) => {
                modalTitle.textContent = title;
                modalTitle.classList.toggle('text-red-600', isError);
                modalTitle.classList.toggle('text-green-600', !isError);
                modalBody.innerHTML = content;
                modal.classList.remove('hidden');
            };

            const hideModal = () => {
                modal.classList.add('hidden');
            };

            modalCloseBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { 
                    hideModal();
                }
            });

            // --- Helper: Get today's date in YYYY-MM-DD ---
            const getTodayDate = () => new Date().toISOString().split('T')[0];

            // --- Data Management ---

            // Load Company Name
            const loadCompanyName = () => {
                companyName = localStorage.getItem(COMPANY_STORAGE_KEY) || '';
                companyNameInput.value = companyName;
            };

            // Save Company Name
            const saveCompanyName = () => {
                companyName = companyNameInput.value.trim();
                localStorage.setItem(COMPANY_STORAGE_KEY, companyName);
            };
            companyNameInput.addEventListener('input', saveCompanyName);

            // Sort bills by date (newest first)
            const sortBills = () => {
                bills.sort((a, b) => {
                    const dateA = new Date(a.day);
                    const dateB = new Date(b.day);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateB - dateA; // Sort by date descending
                    }
                    // If dates are same, sort by time ascending (if available)
                    if (a.time && b.time) {
                        return a.time.localeCompare(b.time);
                    }
                    return a.time ? 1 : (b.time ? -1 : 0); // Put entries without time last
                });
            };

            // Save bills to localStorage
            const saveBills = () => {
                localStorage.setItem(BILLS_STORAGE_KEY, JSON.stringify(bills));
            };

            // Update total amount display
            const updateTotal = () => {
                const total = bills.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                totalAmountCell.textContent = total.toFixed(2);
            };

            // Main function to clear, sort, and re-render all bills
            const renderBills = () => {
                tableBody.innerHTML = ''; // Clear table
                sortBills();
                bills.forEach(bill => addBillToTable(bill));
                updateTotal();
                saveBills();
            };

            // Load bills from localStorage
            const loadBills = () => {
                const storedBills = localStorage.getItem(BILLS_STORAGE_KEY);
                if (storedBills) {
                    try {
                        bills = JSON.parse(storedBills);
                        renderBills();
                    } catch (e) {
                        console.error("Failed to parse stored bills:", e);
                        showModal("Load Error", "Could not load previously saved data.");
                        bills = [];
                    }
                }
            };
            
            // Add a bill object to the table DOM
            const addBillToTable = (bill) => {
                const newRow = document.createElement('tr');
                newRow.classList.add('hover:bg-gray-50');
                newRow.setAttribute('data-id', bill.id);
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="view-mode">${bill.day}</span>
                        <input type="date" class="edit-mode edit-input" value="${bill.day}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="view-mode">${bill.time || '---'}</span>
                        <input type="time" class="edit-mode edit-input" value="${bill.time}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="view-mode">${bill.from || '---'}</span>
                        <input type="text" class="edit-mode edit-input" value="${bill.from}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="view-mode">${bill.to || '---'}</span>
                        <input type="text" class="edit-mode edit-input" value="${bill.to}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="view-mode">${bill.transport}</span>
                        <input type="text" class="edit-mode edit-input" value="${bill.transport}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                        <span class="view-mode">${parseFloat(bill.amount).toFixed(2)}</span>
                        <input type="number" min="0" step="0.01" class="edit-mode edit-input text-right" value="${parseFloat(bill.amount).toFixed(2)}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        <button class="text-blue-600 hover:text-blue-900 edit-btn">Edit</button>
                        <button class="text-red-600 hover:text-red-900 remove-btn">Remove</button>
                    </td>
                `;
                tableBody.appendChild(newRow);
            };

            // --- Form and Action Handlers ---

            // Handle new bill form submission
            billForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount < 0) {
                    showModal("Invalid Input", "Please enter a valid amount.");
                    return;
                }
                if (!dayInput.value) {
                    showModal("Invalid Input", "Please select a date.");
                    return;
                }
                if (!transportInput.value.trim()) {
                    showModal("Invalid Input", "Please enter a category (e.g., Bus, Food).");
                    return;
                }

                const newBill = {
                    id: Date.now().toString(),
                    day: dayInput.value,
                    time: timeInput.value || '', // Save empty string if no time
                    from: fromInput.value.trim(),
                    to: toInput.value.trim(),
                    transport: transportInput.value.trim(),
                    amount: amount
                };

                bills.push(newBill);
                renderBills(); // Sort, render, save

                billForm.reset();
                // Set date back to today after reset
                dayInput.value = getTodayDate(); 
            });

            // Handle table actions (Edit, Save, Remove) using event delegation
            tableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                
                const rowId = row.dataset.id;
                const billIndex = bills.findIndex(b => b.id === rowId);

                // --- REMOVE ---
                if (e.target.classList.contains('remove-btn')) {
                    if (confirm("Are you sure you want to remove this entry?")) {
                         bills.splice(billIndex, 1); // Remove from array
                         renderBills(); // Sort, render, save
                    }
                    return; // Stop further execution
                }
                
                // --- EDIT / SAVE ---
                const editSaveBtn = e.target.closest('.edit-btn, .save-btn');
                if (editSaveBtn) {
                    if (editSaveBtn.classList.contains('edit-btn')) {
                        // Enter editing mode
                        row.classList.add('editing');
                        editSaveBtn.textContent = 'Save';
                        editSaveBtn.classList.remove('edit-btn', 'text-blue-600', 'hover:text-blue-900');
                        editSaveBtn.classList.add('save-btn', 'text-green-600', 'hover:text-green-900');
                    } else if (editSaveBtn.classList.contains('save-btn')) {
                        // Save changes
                        const inputs = row.querySelectorAll('.edit-input');
                        const updatedAmount = parseFloat(inputs[5].value);

                        if (isNaN(updatedAmount) || updatedAmount < 0) {
                            showModal("Invalid Input", "Please enter a valid amount during edit.");
                            return;
                        }

                        // Update bill object in array
                        const updatedBill = {
                            id: rowId,
                            day: inputs[0].value,
                            time: inputs[1].value || '',
                            from: inputs[2].value.trim(),
                            to: inputs[3].value.trim(),
                            transport: inputs[4].value.trim(),
                            amount: updatedAmount
                        };
                        
                        if (!updatedBill.transport) {
                             showModal("Invalid Input", "Category cannot be empty.");
                            return;
                        }
                        
                        bills[billIndex] = updatedBill;
                        
                        // Exit editing mode
                        row.classList.remove('editing');
                        editSaveBtn.textContent = 'Edit';
                        editSaveBtn.classList.remove('save-btn', 'text-green-600', 'hover:text-green-900');
                        editSaveBtn.classList.add('edit-btn', 'text-blue-600', 'hover:text-blue-900');
                        
                        renderBills(); // Sort, render, save
                    }
                }
            });
            
            // --- PDF and CSV Download Functions ---
            const { jsPDF } = window.jspdf;

            const getFormattedFilename = (ext, dateStr) => {
                const date = dateStr || getTodayDate();
                const compName = companyName.trim() || 'Report';
                return `${compName}_${date}.${ext}`;
            };

            // Generic PDF Function
            const downloadPdf = (dataToExport, filename) => {
                const doc = new jsPDF();
                const tableHead = [['Day', 'Time', 'Item/From', 'Vendor/To', 'Category', 'Amount (Tk.)']];
                const tableBodyData = dataToExport.map(bill => [
                    bill.day,
                    bill.time || '---',
                    bill.from || '---',
                    bill.to || '---',
                    bill.transport,
                    parseFloat(bill.amount).toFixed(2)
                ]);
                
                const total = dataToExport.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);

                doc.setFontSize(18);
                doc.text(`${companyName} - Bill Report`, 14, 22);
                
                doc.autoTable({
                    head: tableHead,
                    body: tableBodyData,
                    startY: 30,
                    headStyles: { fillColor: [37, 99, 235] }, // Blue-600
                    foot: [
                        ['', '', '', '', 'Total', total.toFixed(2)]
                    ],
                    footStyles: {
                        fillColor: [229, 231, 235], // gray-200
                        textColor: [0, 0, 0],
                        fontStyle: 'bold'
                    }
                });
                
                doc.save(filename);
            };

            // Generic CSV Function
            const downloadCsv = (dataToExport, filename) => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Day,Time,Item/From,Vendor/To,Category,Amount\n"; // Header row

                dataToExport.forEach(bill => {
                    const row = [
                        `"${bill.day}"`,
                        `"${bill.time || ''}"`,
                        `"${bill.from.replace(/"/g, '""') || ''}"`, 
                        `"${bill.to.replace(/"/g, '""') || ''}"`,
                        `"${bill.transport.replace(/"/g, '""')}"`,
                        parseFloat(bill.amount).toFixed(2)
                    ].join(",");
                    csvContent += row + "\n";
                });
                
                const total = dataToExport.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
                csvContent += `\n,,,,Total,${total.toFixed(2)}\n`;

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // "Download All" Buttons
            downloadPdfBtn.addEventListener('click', () => {
                if (bills.length === 0) return showModal("Error", "No bills to download.");
                downloadPdf(bills, getFormattedFilename('pdf'));
            });

            downloadCsvBtn.addEventListener('click', () => {
                if (bills.length === 0) return showModal("Error", "No bills to download.");
                downloadCsv(bills, getFormattedFilename('csv'));
            });

            // "Finalize Day's Report" Button
            finalizeDayBtn.addEventListener('click', () => {
                const today = getTodayDate();
                const todayBills = bills.filter(bill => bill.day === today);

                if (todayBills.length === 0) {
                    showModal("No Data", "There are no bill entries for today to finalize.");
                    return;
                }

                showModal("Report Generated", `Downloading reports for ${today}...`, false);
                // Download both files for today
                downloadPdf(todayBills, getFormattedFilename('pdf', today));
                downloadCsv(todayBills, getFormattedFilename('csv', today));
            });

            // --- Initialization ---
            loadCompanyName();
            loadBills();
            dayInput.value = getTodayDate();
        });
    </script>

</body>
</html>

